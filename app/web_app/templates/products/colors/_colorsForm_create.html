<form @submit.prevent="submitForm" autocomplete="off">

  <div class="form-floating mb-3">
    <input type="text" class="form-control text-uppercase"
           id="code" placeholder="Ej: Escolar"
           x-model="form.code"
           @input= "checkCode()"
           required>
    <label for="code">C√≥digo</label>
    <template x-if="existing_code" >
        <span id="codeFeedback" class="text-danger">
             üö´ El c√≥digo ya existe.
        </span>
    </template>
  </div>

  <div class="form-floating mb-3">
    <input type="text" class="form-control"
           id="name" placeholder="Ej: Escolar"
           x-model="form.name"
           @input = "checkName()"
           required>
    <label for="name">Nombre</label>
    <template x-if="existing_name" >
        <span id="codeFeedback" class="text-danger">
             üö´ El nombre de color ya existe.
        </span>
    </template>
  </div>

  <div class="form-floating mb-3 text-uppercase">
    <input type="text" class="form-control"
           id="hex" placeholder="Ej: Escolar"
           x-model="form.hex_value"
           >
    <label for="hex">HEX</label>
  </div>

   <div class="form-floating mb-3">
    <textarea class="form-control" id="description"
              placeholder="Descripci√≥n" style="height: 80px"
              x-model="form.description"></textarea>
    <label for="description">Descripci√≥n (opcional)</label>
  </div>



  <div class="d-flex justify-content-end mt-4">
    <button type="submit" class="btn btn-dark" :disabled="existing_code">Guardar</button>
  </div>

</form>

<script>
function colorsForm() {
  return {
    loading: false,
    form: {
      name: '',
      code:'',
      description: '',
      hex_value: '',
    },
    message: '',
    success: false,
    errors:'',
    existing_code:false,
    existing_name:false,


    init() {
      // Opcional: l√≥gica inicial
    },

    async checkCode(){
        try{
            const res = await fetch(`/api/v1/colors?code=${this.form.code.toUpperCase()}`);
            const data = await res.json()
            console.info('check: ', data)
            this.existing_code = false;
            if (data!==null && data[0].code){
                console.info('lpo: 0', this.existing_code)
                this.existing_code = true;
                console.info('lpo: 1', this.existing_code)
                return true
                }
                else{
                this.existing_code = false;
                return false
                }
        }catch(err){
            console.error()
            this.message = err.toString()
        }
    },

    async checkName(){
        try{
            const res = await fetch(`/api/v1/colors?name=${this.form.name}`);
            const data = await res.json()
            if (data.code){
                this.existing_name = true;
                return true
                }
                else{
                this.existing_name = false;
                return false
                }
        }catch(err){
            console.error()
            this.message = err.toString()
        }
    },


    async submitForm() {
      this.loading = true;
      this.message = '';
      try {
        const res = await fetch('/api/v1/colors', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(this.form),
        });
        const data = await res.json();
        this.success = res.ok;
        this.message = this.success ? 'Registro creado con √©xito' : (data.message || '‚ùå Error al crear registro');
        if (this.success) {
          this.form.name = '';
          this.form.code = '';
          this.form.description = '';
          alert(this.message)
          window.location.href = '/products/colors';
        }
      } catch (err) {
        console.error(err);
        this.success = false;
        this.message = '‚ùå Error de conexi√≥n';
        console.log(this.message)
      } finally {
        this.loading = false;
      }
    }
  }
}


</script>
