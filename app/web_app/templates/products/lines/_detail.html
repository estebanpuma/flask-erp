<div x-data="detailLine({{id}})">
    <div class="card px-0">
        <div class="card-body">
            <!-- Fila de Estado -->
            <div class="d-flex justify-content-end mb-2">
                <span
                    class="badge"
                    :class="line.is_active ? 'text-bg-success' : 'text-bg-secondary'"
                    x-text="line.is_active ? 'Activo' : 'Inactivo'">
                </span>
            </div>

            <!-- Fila de Nombre -->
            <div class="mb-3">
                <div class="text-muted">Nombre de la línea</div>
                <div class="d-flex justify-content-between rounded-2 form-control cursor-pointer"
                @click="$dispatch('open-generic-editor', {
                        title: 'Nombre',
                        label: 'Nombre',
                        field: 'name',
                        value: line.name,
                        type: 'text',
                        patchUrl: `/api/v1/product-lines/${id}`,
                        help: 'El nombre debe tener al menos 3 caracteres.',
                        onSave: (updated) => { line.name = updated.name; }
                    })">
                    <div x-text="line.name"></div>
                    <div> <i class="bi bi-chevron-right"></i></div>
                </div>
            </div>

            <!-- Fila de Código -->
            <div class="mb-3">
                <div class="text-muted">Código</div>
                <div class="d-flex justify-content-between rounded-2 form-control bg-light">
                    <div  x-text="line.code?line.code:'Sin codigo'"></div>
                </div>
            </div>

            <!-- Fila de Descripción -->
            <div class="mb-3">
                <div class="text-muted">{{label.description}}</div>
                <div class="d-flex justify-content-between rounded-2 form-control cursor-pointer"
                @click="$dispatch('open-generic-editor', {
                        title: 'Descripción',
                        label: 'Descripción',
                        field: 'description',
                        value: line.description,
                        type: 'textarea',
                        patchUrl: `/api/v1/product-lines/${id}`,
                        help: '',
                        onSave: (updated) => { line.description = updated.description; }
                    })">
                    <div  x-text="line.description?line.description:'Sin descripción'"></div>
                    <div> <i class="bi bi-chevron-right"></i></div>
                </div>
            </div>

            <!-- Fila de estado -->
            <div class="mb-3">
                <div class="text-muted">Estado</div>
                <div class="d-flex justify-content-between form-check  form-switch ps-0">
                    <label  x-text="line.is_active ? 'Activo' : 'Inactivo'"></label>
                    <input class="form-check-input" type="checkbox" role="switch" :checked="line.is_active" @click="toggleStatus()">
                </div>

            </div>
            <!-- Fila de Total Productos -->
            <div class="mb-3">
                <div class="text-muted">{{label.products}}</div>
                <div class="d-flex justify-content-between rounded-2 ">
                    <div class="">Total productos:</div>
                    <div  x-text="line.count_products" class="badge text-bg-primary rounded-pill"></div>

                </div>
            </div>

            <div class="mb-3">
                <div class="text-muted">{{label.collections}}</div>
                <div class="d-flex justify-content-between rounded-2 ">
                    <div class="">Total {{label.collections}}:</div>
                    <div  x-text="collections.length" class="badge text-bg-primary rounded-pill"></div>
                </div>
            </div>
            <div class="mb-3">
                <div class="text-muted">Lista de {{label.collections}}</div>
                <ol class="list-group rounded-top">
                    <template x-for="collection in collections" :key="collection.id">
                        <a :href="'/products/collections/'+collection.id" class="list-group-item list-group-item-action  d-flex justify-content-between cursor-pointer">
                            <div class="d-flex align-items-center">
                                <span
                                class="rounded-circle me-2"
                                style="display: inline-block; width: 8px; height: 8px;"
                                :class="collection.is_active ? 'bg-success' : 'bg-secondary'">
                                </span>
                                <div x-text="collection.name"></div>
                            </div>

                            <div> <i class="bi bi-chevron-right"></i></div></div>
                        </a>
                    </template>
                </ol>
            </div>

            <!-- Zona de Acciones Peligrosas -->
            <div class="mt-5 pt-4 border-top">
                <template x-if="line.count_products === 0">
                    <button @click="deleteLine()" class="btn btn-sm btn-outline-danger">
                        <i class="bi bi-trash"></i> Eliminar Línea Permanentemente
                    </button>
                </template>
            </div>

        </div>
    </div>

</div>

<script>
    function detailLine(id){
        return{
            line:{},
            error:'',
            form:{},
            message:'',
            collections:[],
            id: id,

            init(){
                this.fetchLine(id);
                this.fetchCollections(id);
            },

            async fetchLine(id){
                try {
                    let res = await window.guifer.helpers.fetch.apiFetch('GET', `product-lines/${id}`);
                    this.line = res;
                    console.log('res: ', res);
                }catch(error){
                    console.error('API error: ', error)
                    this.error = 'Error consultando API' + String(error)
                }
            },

            async fetchCollections(id) {
                try {
                    const res = await window.guifer.helpers.fetch.apiFetch('GET', `/product-collections?line_id=${id}`);
                    if (res) {
                        this.collections = res;
                    }
                }
                catch (error) {
                    }
            },

            async toggleStatus() {
                if (!confirm('¿Estás seguro de que quieres cambiar el estado, los productos de esta linea no estaran disponibles para la venta ni produccion?')) {
                    return;
                }

                try {
                    const newStatus = !this.line.is_active;
                    const updated = await window.guifer.helpers.fetch.apiFetch('PATCH', `product-lines/${this.id}`, { is_active: newStatus });
                    console.log('updated: ', updated)
                    if (updated) {
                        this.line.is_active = updated.is_active;
                        this.fetchCollections(this.id);
                    }
                } catch (error) {
                    console.error('Error toggling status:', error);
                    alert('No se pudo cambiar el estado.');
                }
            },

            async deleteLine() {
                if (!confirm('¿Estás seguro de que quieres eliminar esta línea? Esta acción no se puede deshacer.')) {
                    return;
                }

                try {
                    await window.guifer.helpers.fetch.apiFetch('DELETE', `product-lines/${this.id}`);
                    alert('Línea eliminada con éxito.');
                    window.location.href = '/products/lines';
                } catch (error) {
                    console.error('Error deleting line:', error);
                    alert('No se pudo eliminar la línea. Es posible que aún tenga colecciones o productos asociados.');
                }
            }

        }
    }
</script>
