<div x-data="detailLine({{id}})">
    <div class="card px-0">
        <div class="card-body">
            <div class="mb-3">
                <div class="text-muted">Nombre de la línea</div>
                <div class="d-flex justify-content-between rounded-2 form-control cursor-pointer"
                @click="$dispatch('open-generic-editor', {
                        title: 'Nombre',
                        label: 'Nombre',
                        field: 'name',
                        value: line.name,
                        type: 'text',
                        patchUrl: '/api/v1/product-lines/{{id}}',
                        help: 'El nombre debe tener al menos 3 caracteres.',
                        onSave: () => { console.log('¡Guardado!');location.reload(); alert('GUuuardado!');  }
                    })">
                    <div x-text="line.name"></div>
                    <div> <i class="bi bi-chevron-right"></i></div>
                </div>
            </div>
            <div class="mb-3">
                <div class="text-muted">Código</div>
                <div class="d-flex justify-content-between rounded-2 form-control cursor-pointer">
                    <div  x-text="line.code?line.code:'Sin codigo'"></div>
                    <div> <i class="bi bi-chevron-right"></i></div>
                </div>
            </div>
            <div class="mb-3">
                <div class="text-muted">{{label.description}}</div>
                <div class="d-flex justify-content-between rounded-2 form-control cursor-pointer"
                @click="$dispatch('open-generic-editor', {
                        title: 'Descripción',
                        label: 'Descripción',
                        field: 'description',
                        value: line.description,
                        type: 'text',
                        patchUrl: '/api/v1/product-lines/{{id}}',
                        help: '',
                        onSave: () => { console.log('¡Guardado!');location.reload(); alert('✅Guardado!');  }
                    })">
                    <div  x-text="line.description?line.description:'Sin descripción'"></div>
                    <div> <i class="bi bi-chevron-right"></i></div>
                </div>
            </div>
            <div class="mb-3">
                <div class="text-muted">{{label.products}}</div>
                <div class="d-flex justify-content-between rounded-2 ">
                    <div class="">Numero de productos:</div>
                    <div  x-text="line.count_products" class="badge text-bg-primary rounded-pill"></div>

                </div>
            </div>

            <div class="mb-3">
                <div class="text-muted">{{label.collections}}</div>
                <div class="d-flex justify-content-between rounded-2 ">
                    <div class="">Numero de {{label.collections}}:</div>
                    <div  x-text="collections.length" class="badge text-bg-primary rounded-pill"></div>
                </div>
                <div>
                    <ol>
                        <template x-for="collection in collections" :key="collection.id">
                            <li class="list-group-item list-group-item-action">
                                <div x-text="collection.name"></div>
                            </li>
                        </template>
                    </ol>

                </div>
            </div>
        </div>
    </div>

</div>

<script>
    function detailLine(id){
        return{
            line:{},
            error:'',
            form:{},
            message:'',
            collections:[],

            init(){
                this.fetchLine(id);

            },

            async fetchLine(id){
                try{
                    let res = await window.guifer.helpers.fetch.apiFetch('GET', `product-lines/${id}`);

                    // Ordenamos el array de hormas por talla (size) de menor a mayor
                    this.line = res;
                    console.log('res: ', res);
                }catch(error){
                    console.error('API error: ', error)
                    this.error = 'Error consultando API' + String(error)
                }
            },

            async fetchCollections(id) {
                try {
                    const res = await window.guifer.helpers.fetch.apiFetch('GET', `/product-collections?line_id=${id}`);
                    if (res) {
                        this.collections = res;
                    }
                }
                catch (error) {
                    }
            },

            editField(field, data, label, api, type){
                this.type = type??'text';
                this.api = api;
                this.original_value = data;
                this.selectedField = field;
                this.field_label = label;
                this.form_model = data;
                this._offcanvas.show();
                this.form[field] = this.form_model;
                console.log("Offcanvas abierto por JS.");
            },

            async saveField(){
                let url = this.api
                this.form[this.selectedField] = this.form_model;
                console.log('save: ', this.form)
                try{
                    const res = await window.guifer.helpers.fetch.apiFetch('PATCH', url, this.form );
                    this.fetchLastType(id)
                    console.log('repsonse: ', res)

                    alert("Guardado");
                    this.form = {};
                    this._offcanvas.hide();
                }
                catch(err){
                    console.error('ERROR API: ', err)
                }

            },

            resetField(){
                this.form_model = this.original_value
            }

        }
    }
</script>
