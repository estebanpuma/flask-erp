{% extends "base.html" %}
{% block title %}Proceso{% endblock %}
{% from 'components/_pageHeader.html' import pageHeader %}
{% block content %}
<div class="container mt-3">

  <!-- Header de página -->
  {{ pageHeader('/production/operations', title='Detalle') }}
  <!-- Detalle de la operación (usa tu genericDetail existente) -->
  <div
    x-data="genericDetail(
      '/api/v1/operations/{{ id }}',
      [
        { field:'code',      label:'Código' },
        { field:'name',      label:'Nombre' },
        { field:'is_active', label:'Status' },
        { field:'rate_hour', label:'$/hora' },
        { field:'goal',      label:'Objetivo del proceso' },
        { field:'scoope',    label:'Alcance' }
      ],
      '⚙️',
      '/production/operations'
    )"
    class="mb-3"
  >
    {% include "components/detailCard.html" %}
  </div>

  <!-- Recursos + Ficha de operaciones (un solo x-data) -->
  <div x-data="operationView({{ id }})" class="d-grid gap-3">

    <!-- Recursos -->
    <div class="card rounded-4 border-1">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between mb-2">
          <span class="fs-5 fw-semibold">Recursos</span>
          <!-- (Opcional) botón de asignación de recursos -->
          <!-- <a class="btn btn-sm btn-outline-dark" :href="`/production/resources?operation_id=${operationId}`">Asignar</a> -->
        </div>

        <!-- Loading -->
        <template x-if="loading.resources">
          <div class="text-muted small">Cargando recursos…</div>
        </template>

        <!-- Vacío -->
        <template x-if="!loading.resources && !resources.length">
          <div class="text-muted small">Sin recursos asignados a este proceso.</div>
        </template>

        <!-- Chips -->
        <div class="d-flex flex-wrap gap-2">
          <template x-for="r in resources" :key="r.id">
            <span class="badge text-bg-secondary" x-text="r.name"></span>
          </template>
        </div>
      </div>
    </div>



        <!-- Error general -->
        <template x-if="error">
          <div class="alert alert-danger mt-3" x-text="error"></div>
        </template>
      </div>
    </div>

  </div>
</div>

<script>
function operationView(operationId) {
  return {
    operationId,
    resources: [],
    sheet: [],
    loading: { resources: true, sheet: true },
    error: '',
    filters: { resourceId: '', q: '' },

    async init() {
      await Promise.all([this.fetchResources(), this.fetchSheet()]);
    },

    async fetchResources() {
      this.loading.resources = true;
      try {
        const op = await window.guifer.helpers.fetch.apiFetch('GET', `operations/${this.operationId}`);
        this.resources = Array.isArray(op?.resources) ? op.resources : [];
      } catch (e) {
        this.error = 'No se pudieron cargar los recursos.';
      } finally {
        this.loading.resources = false;
      }
    },

    async fetchSheet() {
      this.loading.sheet = true;
      try {
        const res = await window.guifer.helpers.fetch.apiFetch('GET', `operations-sheet?operation_id=${this.operationId}`);
        this.sheet = Array.isArray(res) ? res : [];
      } catch (e) {
        this.error = 'No se pudo cargar la ficha de operaciones.';
      } finally {
        this.loading.sheet = false;
      }
    },

    // Helpers UI
    fmt3(v) {
      const n = Number(v);
      if (Number.isNaN(n)) return '';
      return n.toFixed(3);
    },
    filteredRows() {
      const rid = this.filters.resourceId ? Number(this.filters.resourceId) : null;
      const q = (this.filters.q || '').toLowerCase();
      return this.sheet.filter(row => {
        const byRes = !rid || Number(row.resource_id) === rid;
        const byQ = !q || (row.variant_code?.toLowerCase().includes(q) || row.res_name?.toLowerCase().includes(q));
        return byRes && byQ;
      });
    },
    noop() {}
  };
}
</script>
{% endblock %}


{% block scripts %}
  <script src="{{ url_for('static', filename='js/genericDetail.js') }}"></script>
   <script src="{{ url_for('static', filename='js/genericList.js') }}"></script>
{% endblock %}
