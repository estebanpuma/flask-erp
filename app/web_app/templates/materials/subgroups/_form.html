<form @submit.prevent="submitForm" autocomplete="off" x-data="material_subgroupForm(id)">

    <div class="form-floating mb-3">
        <input type="text" disabled class="form-control text-uppercase"
            id="code" placeholder="Ej: Escolar"
            x-model="form.material_group">
    </div>

    <div class="form-floating mb-3">
        <input type="text" class="form-control"
            id="name" placeholder="Ej: Escolar"
            x-model="form.name"
            @input = "checkName()"
            required>
        <label for="name">Nombre</label>
        <template x-if="existing_name" >
            <span id="codeFeedback" class="text-danger">
                üö´ El nombre ya existe.
            </span>
        </template>
    </div>

   <div class="form-floating mb-3">
    <textarea class="form-control" id="description"
              placeholder="Descripci√≥n" style="height: 80px"
              x-model="form.description"></textarea>
    <label for="description">Descripci√≥n (opcional)</label>
  </div>



  <div class="d-flex justify-content-end mt-4">
    <button type="submit" class="btn btn-dark" :disabled="existing_code">Guardar Serie</button>
  </div>

</form>
<script>
function material_groupForm() {
  return {
    loading: false,
    form: {
      name: '',
      code:'',
      description: '',
    },
    message: '',
    success: false,
    errors:'',
    existing_code:false,
    existing_name:false,


    init() {
      // Opcional: l√≥gica inicial
    },

    async checkCode(){
        try{
            const res = await fetch(`/api/v1/material-groups?code=${this.form.code.toUpperCase()}`);
            const data = await res.json()
            this.existing_code = false;
            if (data!==null && data[0].code){
                this.existing_code = true;
                return true
                }
                else{
                this.existing_code = false;
                return false
                }
        }catch(err){
            console.error()
            this.message = err.toString()
        }
    },

    async checkName(){
        try{
            const res = await fetch(`/api/v1/material-groups?name=${this.form.name.toUpperCase()}`);
            const data = await res.json()
            if (data.code){
                this.existing_name = true;
                return true
                }
                else{
                this.existing_name = false;
                return false
                }
        }catch(err){
            console.error()
            this.message = err.toString()
        }
    },


    async submitForm() {
      this.loading = true;
      this.message = '';
      try {
        const res = await fetch('/api/v1/material-groups', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(this.form),
        });
        const data = await res.json();
        this.success = res.ok;
        this.message = this.success ? '‚úÖ Grupo creado' : (data.message || '‚ùå Error al crear grupo');
        if (this.success) {
          this.form.name = '';
          this.form.code = '';
          this.form.description = '';
          alert(this.message)
          window.location.href = '/materials/groups';
        }else{
          this.success = false;
        this.message = '‚ùå Error de conexi√≥n';
        console.log(this.message)
        }
      } catch (err) {
        console.error(err);
        this.success = false;
        this.message = '‚ùå Error de conexi√≥n';
        console.log(this.message)
      } finally {
        this.loading = false;
      }
    }
  }
}

</script>
