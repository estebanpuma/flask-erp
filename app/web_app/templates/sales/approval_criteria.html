{% extends 'base.html' %}
{% from 'components/entryCard.html' import entry_card %}

{% block content %}
  {% set title = 'Ventas' %}
  {% include 'components/pageHeader.html' %}

   <style>
    body {
      background: #fff;
      color: #18181b;
      font-family: 'Inter', 'Roboto', 'Nunito', sans-serif;
    }
    .rule-card {
      border-radius: 1.5rem;
      border: 1px solid #e5e7eb;
      box-shadow: 0 2px 8px rgba(24,24,27,0.05);
      margin-bottom: 1.5rem;
      padding: 1.5rem 1.5rem 1rem 1.5rem;
      background: #f8f9fa;
      transition: box-shadow .2s;
    }
    .rule-card:hover {
      box-shadow: 0 6px 24px rgba(24,24,27,0.08);
    }
    .badge-auto { background: #10b981; }
    .badge-manual { background: #f59e42; color: #fff; }
    .badge-rechazo { background: #ef4444; color: #fff; }
    .category-title { color: #2563eb; letter-spacing: .5px; margin-top: 2.5rem; }
    .step-flow { background: #e5e7eb; border-radius: 1.5rem; padding: 1.2rem; margin-bottom: 2rem; }
    .config-edit {
      background: #18181b; color: #fff; border: none; border-radius: .5rem;
      padding: 0.3rem 1.1rem; font-size: 1rem;
    }
    .config-input {
      width: 5rem; border-radius: .5rem; border: 1px solid #18181b; padding: .1rem .5rem; margin-left: 0.4rem;
      text-align: right; font-weight: bold; color: #18181b;
    }
    @media (max-width: 767px) {
      .rule-card { padding: 1rem; }
      .category-title { font-size: 1.2rem; }
      .config-input { width: 3.5rem; }
    }
  </style>
    <!-- Título y edición de configuración -->
    <div class="d-flex align-items-center justify-content-between mb-3 flex-wrap">
      <h1 class="fs-3 fw-bold mb-2 mb-md-0">Reglas de Negocio para Aprobación de Pedidos</h1>
      <template x-if="permiso_editar">
        <button class="config-edit ms-md-2" @click="editando = !editando">
          <template x-if="!editando">Ajustar Umbrales</template>
          <template x-if="editando">Cerrar Ajuste</template>
        </button>
      </template>
    </div>
    <p class="text-muted mb-4">Evaluaremos los pedidos en el siguiente orden. Tan pronto como una regla se cumple, el pedido toma el estado correspondiente y no se evalúan las reglas subsiguientes.</p>

    <!-- Flujo de Decisión Visual -->
    <section class="step-flow mb-5">
      <div class="fw-bold mb-2">Flujo de Decisión</div>
      <div class="row g-2 align-items-end">
        <div class="col-12 col-md-6 col-lg-4">
          <div class="mb-2"><span class="badge badge-auto">¿Pago 100%?</span></div>
          <small>Aprobado Automáticamente</small>
        </div>
        <div class="col-12 col-md-6 col-lg-4">
          <div class="mb-2">
            <span class="badge badge-auto">
              ¿Pago parcial &ge;
              <template x-if="!editando">
                <b x-text="porcentaje_aprobacion + '%'"></b>
              </template>
              <template x-if="editando">
                <input type="number" min="1" max="99" class="config-input" x-model.number="porcentaje_aprobacion" @change="guardar()" />%
              </template>
              ?
            </span>
          </div>
          <small>Aprobado Automáticamente</small>
        </div>
        <div class="col-12 col-md-6 col-lg-4">
          <div class="mb-2"><span class="badge badge-manual">¿Pago parcial menor al umbral?</span></div>
          <small>Pendiente Revisión Manual</small>
        </div>
        <div class="col-12 col-md-6 col-lg-4">
          <div class="mb-2"><span class="badge badge-auto">¿Historial excelente?</span></div>
          <small>Aprobado Automáticamente</small>
        </div>
        <div class="col-12 col-md-6 col-lg-4">
          <div class="mb-2"><span class="badge badge-rechazo">¿Problemas recientes?</span></div>
          <small>Rechazo Automático o Pendiente</small>
        </div>
        <div class="col-12 col-md-6 col-lg-4">
          <div class="mb-2"><span class="badge badge-manual">¿Nuevo o historial bueno?</span></div>
          <small>Pendiente Revisión Manual</small>
        </div>
        <div class="col-12 col-md-6 col-lg-4">
          <div class="mb-2">
            <span class="badge badge-auto">
              ¿Monto bajo
              <template x-if="!editando">
                <b x-text="monto_bajo"></b>
              </template>
              <template x-if="editando">
                <input type="number" min="1" class="config-input" x-model.number="monto_bajo_val" @change="guardar()" />USD
              </template>
              ?
            </span>
          </div>
          <small>Aprobado Automáticamente</small>
        </div>
        <div class="col-12 col-md-6 col-lg-4">
          <div class="mb-2">
            <span class="badge badge-manual">
              ¿Monto alto
              <template x-if="!editando">
                <b>&gt; <span x-text="monto_bajo"></span></b>
              </template>
              <template x-if="editando">
                &gt; <input type="number" min="1" class="config-input" x-model.number="monto_bajo_val" @change="guardar()" />USD
              </template>
              ?
            </span>
          </div>
          <small>Pendiente Revisión Manual</small>
        </div>
      </div>
    </section>

    <!-- Criterios y reglas -->
    <section>
      <div class="category-title fw-semibold fs-5">
        Criterio Principal: Método de Pago
      </div>
      <div class="rule-card">
        <div class="d-flex align-items-center mb-2">
          <span class="badge badge-auto me-2">Aprobación Automática</span>
          <span class="fw-semibold">Regla 1: Pago Confirmado</span>
        </div>
        <div class="mb-2"><b>Condición:</b> Método "pagado", "transferencia confirmada", "tarjeta aprobada" u otro método con pago seguro.</div>
        <div><b>Justificación:</b> El riesgo de cobro es nulo.</div>
      </div>
      <div class="rule-card">
        <div class="d-flex align-items-center mb-2">
          <span class="badge badge-auto me-2">Aprobación Automática</span>
          <span class="fw-semibold">Regla 2: Pago Parcial Significativo</span>
        </div>
        <div class="mb-2"><b>Condición:</b> Pago parcial &ge; <span x-text="porcentaje_aprobacion + '%'"></span> del total.</div>
        <div><b>Justificación:</b> Cubre los costos y reduce el riesgo de impago.</div>
      </div>
      <div class="rule-card">
        <div class="d-flex align-items-center mb-2">
          <span class="badge badge-manual me-2">Pendiente Revisión Manual</span>
          <span class="fw-semibold">Regla 3: Pago Parcial Bajo</span>
        </div>
        <div class="mb-2"><b>Condición:</b> Pago parcial menor al umbral configurado.</div>
        <div><b>Justificación:</b> Riesgo moderado, requiere revisión humana.</div>
      </div>
      <div class="rule-card">
        <div class="d-flex align-items-center mb-2">
          <span class="badge badge-manual me-2">Pendiente Revisión Manual</span>
          <span class="fw-semibold">Regla 4: Pago Pendiente / Por Verificar</span>
        </div>
        <div class="mb-2"><b>Condición:</b> "Contra entrega", "cheque en tránsito", "transferencia por verificar", "crédito a 30 días" sin historial de crédito pre-aprobado.</div>
        <div><b>Justificación:</b> Requiere verificación de solvencia.</div>
      </div>
    </section>

    <section>
      <div class="category-title fw-semibold fs-5">
        Criterio Secundario: Historial de Pagos del Cliente
      </div>
      <div class="rule-card">
        <div class="d-flex align-items-center mb-2">
          <span class="badge badge-auto me-2">Aprobación Automática</span>
          <span class="fw-semibold">Regla 5: Historial Excelente</span>
        </div>
        <div class="mb-2"><b>Condición:</b> Cliente con 100% de pagos a tiempo en los últimos 12-24 meses.</div>
        <div><b>Justificación:</b> El cliente ha demostrado confiabilidad.</div>
      </div>
      <div class="rule-card">
        <div class="d-flex align-items-center mb-2">
          <span class="badge badge-rechazo me-2">Rechazo / Pendiente</span>
          <span class="fw-semibold">Regla 6: Historial con Problemas Recientes</span>
        </div>
        <div class="mb-2"><b>Condición:</b> Deudas activas o múltiples atrasos en 6-12 meses.</div>
        <div><b>Justificación:</b> Alto riesgo de impago.</div>
      </div>
      <div class="rule-card">
        <div class="d-flex align-items-center mb-2">
          <span class="badge badge-manual me-2">Pendiente Revisión Manual</span>
          <span class="fw-semibold">Regla 7: Nuevo o Historial Bueno</span>
        </div>
        <div class="mb-2"><b>Condición:</b> Clientes nuevos o con historial bueno, sin atrasos graves.</div>
        <div><b>Justificación:</b> Riesgo desconocido o bajo/moderado.</div>
      </div>
    </section>

    <section>
      <div class="category-title fw-semibold fs-5">
        Criterio Terciario: Monto del Pedido
      </div>
      <div class="rule-card">
        <div class="d-flex align-items-center mb-2">
          <span class="badge badge-auto me-2">Aprobación Automática</span>
          <span class="fw-semibold">Regla 8: Monto Bajo</span>
        </div>
        <div class="mb-2"><b>Condición:</b> Monto total bajo (<span x-text="monto_bajo"></span>).</div>
        <div><b>Justificación:</b> Riesgo bajo, pérdida potencial mínima.</div>
      </div>
      <div class="rule-card">
        <div class="d-flex align-items-center mb-2">
          <span class="badge badge-manual me-2">Pendiente Revisión Manual</span>
          <span class="fw-semibold">Regla 9: Monto Alto</span>
        </div>
        <div class="mb-2"><b>Condición:</b> Monto total superior al umbral (<b>&gt; </b><span x-text="monto_bajo"></span>).</div>
        <div><b>Justificación:</b> Justifica revisión humana por riesgo.</div>
      </div>
    </section>

  <!-- Bootstrap Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Alpine.js config -->
  <script>
    function aprobacionConfig() {
      return {
        // Valores iniciales pueden venir de backend/Jinja
        porcentaje_aprobacion: 50,
        monto_bajo_val: 200,
        editando: false,
        permiso_editar: true, // poner a false si el usuario no debe editar

        get monto_bajo() {
          return '$' + this.monto_bajo_val;
        },
        guardar() {
          // Aquí podrías hacer un fetch/POST al backend para guardar la config si lo deseas.
          // Por ahora solo actualiza local.
          // Ejemplo:
          // fetch('/api/v1/config', { method: 'POST', body: JSON.stringify({porcentaje_aprobacion: this.porcentaje_aprobacion, monto_bajo: this.monto_bajo_val}) })
        }
      }
    }
  </script>
{% endblock %}
