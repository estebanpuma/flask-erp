



<div
    class="offcanvas offcanvas-end"
    tabindex="-1"
    id="genericEditOffcanvas"
    aria-labelledby="genericEditOffcanvasLabel"
    x-data="genericEditor()"
    x-init="init()"
    @open-generic-editor.window="open($event.detail)"
    x-ref="offcanvas"
    @updated-value.window="formValue = $event.detail"

>
    <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="genericEditOffcanvasLabel" x-text="title || 'Editar Campo'"></h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Cerrar"></button>
    </div>
    <div class="offcanvas-body">
        <form @submit.prevent="save">
            <p class="text-muted small" x-show="help" x-text="help"></p>

            <!-- Input dinámico según el tipo -->
            <div class="mb-3">
                <label :for="field" class="form-label" x-text="label"></label>
                <template x-if="type === 'text' || type === 'email' || type === 'tel'">
                    <input :type="type" class="form-control" :id="field" x-model="formValue">
                </template>
                <template x-if="type === 'number'">
                    <input type="number" class="form-control" :id="field" x-model.number="formValue">
                </template>
                <template x-if="type === 'textarea'">
                    <textarea class="form-control" :id="field" x-model="formValue" rows="4"></textarea>
                </template>
                <template x-if="type === 'select'">
                    <div>
                        <select class="form-select" :id="field" x-model="formValue" @change="fetchCantons()">
                            <option value="">Seleccione una opción</option>
                            <template x-for="option in formOptions" :key="option.id">
                                <option :value="option.id"  x-text="option.name"></option>
                            </template>
                        </select>


                        <template x-if="field==='province_id'">
                            <div class="mt-3">
                                <label for="canton" class="form-label">Canton</label>
                                <select class="form-select" :id="'canton'" x-model="canton_id" >
                                    <option value="">Seleccione una opción</option>
                                    <template x-for="canton in cantons" :key="canton.id">
                                        <option :value="canton.id"  x-text="canton.name"></option>
                                    </template>
                                </select>
                            </div>

                        </template>

                    </div>

                </template>

            </div>

            <!-- Mensajes de estado -->
            <div x-show="message" class="alert" :class="success ? 'alert-success' : 'alert-danger'" x-text="message"></div>

            <!-- Acciones -->
            <div class="d-flex justify-content-end gap-2 mt-4">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="offcanvas">Cancelar</button>
                <button type="submit" class="btn btn-dark" :disabled="loading">
                    <span x-show="!loading">Guardar Cambios</span>
                    <span x-show="loading" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                    <span x-show="loading"> Guardando...</span>
                </button>
            </div>
        </form>
    </div>
</div>

<script>
function genericEditor() {
    return {
        // --- Estado del componente ---
        _offcanvas: null,
        title: 'Editar Campo',
        label: 'Valor',
        field: '',
        formValue: '',
        originalValue: '',
        type: 'text',
        patchUrl: '',
        help: '',
        onSaveCallback: null,
        loading: false,
        message: '',
        success: false,

        cantons:[],
        canton_id:'',

        formOptions: [],


        // --- Métodos ---
        init() {
            this._offcanvas = new bootstrap.Offcanvas(this.$refs.offcanvas);

        },

        open(detail) {
            this.title = detail.title || 'Editar Campo';
            this.label = detail.label || 'Valor';
            this.field = detail.field;
            this.formValue = detail.value;
            this.formOptions = detail.options || [];
            this.originalValue = detail.value;
            this.type = detail.type || 'text';
            this.patchUrl = detail.patchUrl;
            this.help = detail.help || '';
            this.onSaveCallback = detail.onSave; // Guardar el callback
            this.message = '';
            this.success = false;
            this.loading = false;
            this._offcanvas.show();
            if(this.field === 'province_id'){
                this.fetchCantons();
            }

        },

        async fetchCantons(){
            try{
                const res = await window.guifer.helpers.fetch.apiFetch('GET', 'cantons?province_id='+this.formValue);
                console.log('res: ', res);
                this.cantons = res;
            }catch(err){
                console.error('API error: ', error)
            }
        },


        async save() {
            if (!this.patchUrl || !this.field) return;

            this.loading = true;
            this.message = '';

            try {
                let payload = { [this.field]: this.formValue };
                if(this.field === 'province_id'){
                    const canton = this.cantons.find(canton => canton.id == this.canton_id);

                    if (!canton || canton.province_id != this.formValue) {
                        this.message = 'Debe elegir un canton que pertenezca a la provincia'
                        return;
                    }
                    payload = {};
                    payload.province_id = this.formValue;
                    payload.canton_id = this.canton_id;
                }
                const response = await fetch(this.patchUrl, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.message || `Error ${response.status}`);
                }

                this.success = true;
                this.message = '¡Guardado con éxito!';
                this.$dispatch('updated-value', {field: this.field, value: this.formValue});

                               // Ejecutar callback si existe
                if (typeof this.onSaveCallback === 'function') {
                    this.onSaveCallback(data);
                }

                setTimeout(() => this._offcanvas.hide(), 500);

            } catch (error) {
                this.success = false;
                this.message = error.message || 'Ocurrió un error inesperado.';
                console.error('Error al guardar:', error);
            } finally {
                this.loading = false;
            }
        }
    }
}
</script>
