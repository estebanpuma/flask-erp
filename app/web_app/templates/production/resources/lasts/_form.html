{% from 'components/_pageHeader.html' import pageHeader %}
<div action="" style="max-width: 560px;" class="my-4" x-data="prForm()">
    {{ pageHeader(href='/production/resources', title='Crear Recurso') }}
    <template x-if="error">
        <div x-html="window.guifer.components.alert.alert({msg:error, type:'danger'})"></div>
    </template>

    <template x-if="notice"><div class="alert alert-info" x-text="notice"></div></template>

    <!-- inputs  -->
    <div class="card border-0 shadow-sm">
        <div class="card-body">
            <h2 class="h6 mb-3">1. Datos del recurso</h2>
            <p class="text-muted small mb-3">Información general.   </p>

            <form action="" autocomplete="off" >

                <p class="text-muted small mb-3">Qué tipo de recurso es?</p>

                <div x-data="inputSelect({label:'Tipo*',
                                            id:'resource',
                                            show:'name',
                                            change:'',
                                            list:'resources'})"
                    x-model="form.kind"
                    x-modelable="value"
                    @change="labor()"></div>

                <div>
                    <a  class="btn btn-dark" href="/production/lasts/setup">Hormas</a>
                </div>


                <div x-show="kind_selected">
                    <div>
                        <div x-show="is_labor">
                            <div x-data="inputSelect({label:'Puesto*',
                                                    id:'job',
                                                    show:'name',
                                                    change:'',
                                                    list:'jobs'})"
                            x-model="job_id"
                            x-modelable="value"
                            @change="selectLabor()"
                            ></div>
                        </div>

                        <div x-show="!is_labor">
                            <div>
                                <p class="text-muted small mb-3">Nombre</p>
                                <div x-data="inputText({label:'Nombre*', id:'name' })"
                                    x-model="form.name"
                                    x-modelable="value"
                                    @input.debounce.300="validateName()">
                                </div>
                            </div>
                        </div>
                        <div x-data="inputTextArea({label:'Descripción'})"
                            x-model="form.description"
                            x-modelable="value">
                        </div>
                    </div>
                </div>





                <div class="d-flex justify-content-between mb-3">
                    <div class="fs-6">Cantidad:</div>
                    <div x-data="inputQty({ initial:1, step:1, min:1, max:100, size:'lg' })"
                        x-modelable="value"
                        x-model="form.qty"
                        class="d-flex align-items-center gap-1 mb-2">
                    </div>
                </div>

                <div class="d-flex justify-content-between mb-3">
                    <div class="fs-6">Precio por hora($/h):</div>
                    <div x-data="inputQty({ initial:0, step:0.01, min:0, max:1000, size:'lg', id:'rate_hour'})"
                        x-modelable="value"
                        x-model="form.rate_hour"
                        class="d-flex align-items-center gap-1 mb-2">
                    </div>
                </div>

                <div x-data="{open: false}">
                    <h2 class="h6 mb-3">2. Datos opcionales <button type="button" class="btn btn-link" @click="open = !open" ><i class="bi bi-chevron-down"></i></button></p> </h2>
                    <p class="text-muted small mb-3">Campos adicionales.   </p>
                    <div x-show="open">
                        <div x-data="inputText({label:'Código adicional', id:'code_doc', help:'Código para sistema de gestión documental'})"
                        x-model="form.code_doc"
                        x-modelable="value">
                        </div>

                    </div>

                </div>
            </form>
            <div class="d-flex pt-3">
                <div x-data="actionBtn({label:'Guardar', loading:loading})" @click="submitForm" type="submit" class="flex-grow-1 me-2"></div>
                <div x-data="actionBtn({label:'Cancelar', variant:'outline-dark'} )" class=""></div>
            </div>
        </div>
    </div>
</div>
<script >
function prForm(){
    return{
        form:{
            name:'',
            qty:1,
            kind:'',
            rate_hour: 0,
            efficiency:1,
            operation_id:'',
            code_doc:'',
        },
        job_id:'',

        kind_selected:false,
        is_labor: false,
        error:'',
        notice:'',
        errors:{name:false},
        error_name:'',
        resources: [
            {id:'labor', name:'Mano de obra'},
            {id:'machine', name:'Maquinaria'},
            {id:'tool', name:'Herramienta'}
        ],
        jobs:[],
        operations:[],
        loading: false,

        init(){
            console.info('Init...')
            this.fetchOps()
            this.fetchJobs()
        },

        labor(){
            this.is_labor = false
            this.kind_selected = true
            if(this.form.kind==='labor') {
                this.is_labor = true;
                this.fetchJobs()
            }
        },

        async fetchOps(){
            const res = await window.guifer.helpers.fetch.apiFetch('GET', 'operations');
            console.log(res)
            this.operations = res;
        },

        async fetchName(){
            const res = await window.guifer.helpers.fetch.apiFetch('GET', `production-resources?name=${this.form.name}`)
            return res
        },

        async fetchJobs(){
            const res = await window.guifer.helpers.fetch.apiFetch('GET', 'jobs');
            this.jobs = res;
            console.log('jobs: ', this.jobs)
        },

        selectLabor() {
            const selected_job = this.jobs.find(job => String(job.id) === String(this.job_id));

            // 1. Manejo seguro para cuando el trabajo no se encuentra.
            if (!selected_job) {
                this.form.name = null;
                this.form.rate_hour = 0;
                this.form.qty = 0;
                console.warn('Trabajo no encontrado para el ID:', this.job_id);
                return;
            }

            // 2. Asignar el nombre del trabajo y description de forma segura.
            this.form.name = selected_job.name;
            this.form.description = selected_job.description?selected_job.description:''
            // 3. Usar `reduce` para calcular la suma de forma más limpia.
            const totalRateHours = selected_job.workers.reduce((sum, worker) => {
                return sum + Number(worker.hour_rate_normal);
            }, 0);

            // 4. Calcular la cantidad de trabajadores usando la propiedad length.
            const workers_cont = selected_job.workers.length;

            // 5. Asignar los valores al formulario, con un control para evitar división por cero.
            this.form.rate_hour = workers_cont > 0 ? Number(totalRateHours / workers_cont) : 0;
            this.form.qty = workers_cont;
            console.info('form:', this.form)
        },

        validateName(){
            console.log('validate nomre')
            const res = this.fetchName().then(res=>{
                console.log(res)
                if(res && res.length>0){
                    console.log('this res', res)
                    this.error= 'Ya existen recursos con ese nombre';
                    return true
                }else{
                    this.error= '';
                    return false
                }
                })
        },

        validateData(){
            console.log('entra a validar')
            if( this.validateName()){

                console.log('que carajo')
                console.log('this valnme', this.validateName())
                return false
            }
            console.log('pasa validateNme')
            if(!this.form.name) {

                this.error = 'Debe establecer un nombre'
                console.log('2erro val', this.error)
                return false
            };
            this.error = '';
            return true
        },

        cancel(){
            this.form = {
                            name:'',
                            qty:0,
                            rate_hour:0,
                            kind:'',
                            efficiency:1,
                            operation_id:'',
                            code_doc:'',
                        };
            this.error='';
        },

        async submitForm(){
            loading = true
            this.error='';
            if(!this.validateData()) {
                window.scrollTo({ top: 10, behavior: 'smooth' });
                loading = false
                return}

            const payload = this.form
            console.log('payload: ', payload)

            try{
                const res = await window.guifer.helpers.fetch.apiFetch('POST', 'production-resources', payload)
                console.log(res)
                if(res) {
                    window.guifer.components.alert.showToast('Registro guardado', 'success')
                    window.location.href = '/production/resources'
                }

            }catch(err){
                console.error('err', err)
                window.guifer.helpers.ui.showToast(err.message, 'danger');
                window.scrollTo({ top: 10, behavior: 'smooth' });

            }
            loading = false

        }
    }
}
</script>
