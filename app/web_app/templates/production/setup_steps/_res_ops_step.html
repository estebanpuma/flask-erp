<div x-show="step===3" class="mt-3" x-cloak>
    <div class="card border-0 shadow-sm">
      <div class="card-body">
        <h2 class="h5">3. Asocia recursos a cada operación</h2>
        <p class="text-muted small">Para cada operación, indica qué recursos usa y cuántos minutos por unidad aportan.</p>

        <div class="row g-2 align-items-end">
          <div class="col-12 col-md-3">
            <label class="form-label">Operación</label>
            <select class="form-select" x-model="linkForm.operation_uid">
              <option value="" disabled>Selecciona…</option>
              <template x-for="op in operations" :key="op.uid">
                <option :value="op.uid" x-text="op.name"></option>
              </template>
            </select>
          </div>
          <div class="col-12 col-md-3">
            <label class="form-label">Recurso</label>
            <select class="form-select" x-model="linkForm.resource_uid">
              <option value="" disabled>Selecciona…</option>
              <template x-for="r in resources" :key="r.uid">
                <option :value="r.uid" x-text="r.name"></option>
              </template>
            </select>
          </div>
          <div class="col-6 col-md-2">
            <label class="form-label">Min/u</label>
            <input type="number" step="0.001" min="0" class="form-control" x-model.number="linkForm.res_min" placeholder="0.7">
          </div>
          <div class="col-6 col-md-2">
            <label class="form-label">Unid. recurso/u</label>
            <input type="number" step="0.01" min="0" class="form-control" x-model.number="linkForm.qty_required" placeholder="1">
          </div>
          <div class="col-6 col-md-2">
            <label class="form-label">Rol (opcional)</label>
            <input type="text" class="form-control" x-model.trim="linkForm.role" placeholder="operario / máquina">
          </div>
          <div class="col-12 col-md-12">
            <button class="btn btn-dark" @click="addLink()"><i class="bi bi-link-45deg me-1"></i>Agregar a la operación</button>
          </div>
        </div>

        <hr>
        <template x-for="op in operations" :key="op.uid">
          <div class="mb-4">
            <h6 class="mb-2" x-text="op.name"></h6>
            <div class="table-responsive">
              <table class="table table-sm align-middle">
                <thead>
                  <tr>
                    <th>Recurso</th>
                    <th>Min/u</th>
                    <th>Unid. recurso/u</th>
                    <th>Rol</th>
                    <th class="text-end">Acciones</th>
                  </tr>
                </thead>
                <tbody>
                  <template x-if="(op.links||[]).length===0">
                    <tr><td colspan="5" class="text-muted">Sin recursos asignados</td></tr>
                  </template>
                  <template x-for="(lnk, j) in (op.links||[])" :key="lnk.uid">
                    <tr>
                      <td x-text="resourceName(lnk.resource_uid)"></td>
                      <td><input type="number" step="0.001" min="0" class="form-control form-control-sm" x-model.number="lnk.res_min"></td>
                      <td><input type="number" step="0.01" min="0" class="form-control form-control-sm" x-model.number="lnk.qty_required"></td>
                      <td><input type="text" class="form-control form-control-sm" x-model.trim="lnk.role"></td>
                      <td class="text-end">
                        <button class="btn btn-sm btn-outline-danger" @click="removeLink(op, j)"><i class="bi bi-x-circle"></i></button>
                      </td>
                    </tr>
                  </template>
                </tbody>
              </table>
            </div>
          </div>
        </template>
      </div>
    </div>

    <div class="d-flex justify-content-between mt-3">
      <button class="btn btn-outline-dark" @click="back()">Atrás</button>
      <button class="btn btn-dark" @click="next()">Siguiente</button>
    </div>
  </div>
